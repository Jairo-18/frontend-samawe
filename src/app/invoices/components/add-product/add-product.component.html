<form [formGroup]="form" class="w-full mt-3">
  <!-- Buscar producto por nombre -->
  <mat-form-field appearance="outline" class="w-full">
    <mat-label>Buscar Producto</mat-label>
    <input
      matInput
      [matAutocomplete]="auto"
      formControlName="name"
      placeholder="Ejemplo: Coca Cola..."
      (focus)="onProductFocus()"
    />
    <mat-icon matPrefix>inventory</mat-icon>

    <button
      *ngIf="form.get('name')?.enabled && form.get('name')?.value && !isLoading"
      matSuffix
      mat-icon-button
      type="button"
      (click)="clearProductSelection()"
      matTooltip="Limpiar selección"
    >
      <mat-icon>clear</mat-icon>
    </button>

    <mat-autocomplete
      #auto="matAutocomplete"
      (optionSelected)="onProductSelected($event.option.value)"
    >
      <mat-option
        *ngFor="let product of filteredProducts"
        [value]="product.name"
      >
        {{ product.name }}
        <span [ngClass]="product.isActive ? 'text-green-600' : 'text-red-600'">
          - {{ product?.isActive ? 'Activo' : 'Inactivo' }}
        </span>
      </mat-option>
    </mat-autocomplete>

    <!-- Mostrar errores de validación del producto -->
    <mat-error *ngIf="form.get('name')?.hasError('required')">
      Debe seleccionar un producto
    </mat-error>
  </mat-form-field>

  <!-- Campos de precio y cantidad -->
  <div class="flex flex-col md:flex-row gap-0 md:gap-2">
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Precio Unitario</mat-label>
      <input
        matInput
        type="text"
        formControlName="priceSale"
        [readonly]="false"
        appCurrencyFormat
        class="text-right"
        placeholder="0.00"
      />
      <mat-icon matSuffix>attach_money</mat-icon>

      <!-- Mostrar errores de validación -->
      <mat-error *ngIf="form.get('priceSale')?.hasError('required')">
        El precio unitario es requerido
      </mat-error>
      <mat-error *ngIf="form.get('priceSale')?.hasError('min')">
        El precio debe ser mayor o igual a 0
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Precio Final</mat-label>
      <input
        matInput
        type="text"
        formControlName="finalPrice"
        [readonly]="true"
        class="text-right"
        placeholder="0.00"
        appCurrencyFormat
      />
      <mat-icon matSuffix>monetization_on</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Unidades en Existencia</mat-label>
      <input
        matInput
        type="text"
        formControlName="amount"
        [readonly]="true"
        appCurrencyFormat
        class="text-right"
      />
      <mat-icon matSuffix>store</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Cantidad</mat-label>
      <input
        matInput
        type="text"
        formControlName="amountSale"
        appCurrencyFormat
        class="text-right"
        placeholder="1"
      />
      <mat-icon matSuffix>numbers</mat-icon>

      <!-- Mostrar errores de validación -->
      <mat-error *ngIf="form.get('amountSale')?.hasError('required')">
        La cantidad es requerida
      </mat-error>
      <mat-error *ngIf="form.get('amountSale')?.hasError('min')">
        La cantidad debe ser mayor a 0
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Fechas y horas -->
  <div class="flex flex-col md:flex-row gap-0 md:gap-2">
    <!-- Fecha entrada -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Fecha de entrada</mat-label>
      <input
        matInput
        [matDatepicker]="startDatePicker"
        formControlName="startDate"
      />
      <mat-datepicker #startDatePicker></mat-datepicker>
      <mat-datepicker-toggle
        [for]="startDatePicker"
        matSuffix
      ></mat-datepicker-toggle>
      <mat-icon matPrefix>event</mat-icon>
    </mat-form-field>

    <!-- Hora entrada -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Hora de entrada</mat-label>
      <input
        matInput
        [matTimepicker]="startTimePicker"
        formControlName="startTime"
      />
      <mat-timepicker #startTimePicker format="12h"></mat-timepicker>
      <mat-timepicker-toggle
        [for]="startTimePicker"
        matSuffix
      ></mat-timepicker-toggle>
      <mat-icon matPrefix>access_time</mat-icon>
    </mat-form-field>

    <!-- Fecha salida -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Fecha de salida</mat-label>
      <input
        matInput
        [matDatepicker]="endDatePicker"
        formControlName="endDate"
      />
      <mat-datepicker #endDatePicker></mat-datepicker>
      <mat-datepicker-toggle
        [for]="endDatePicker"
        matSuffix
      ></mat-datepicker-toggle>
      <mat-icon matPrefix>event</mat-icon>
    </mat-form-field>

    <!-- Hora salida -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Hora de salida</mat-label>
      <input
        matInput
        [matTimepicker]="endTimePicker"
        formControlName="endTime"
      />
      <mat-timepicker #endTimePicker format="12h"></mat-timepicker>
      <mat-timepicker-toggle
        [for]="endTimePicker"
        matSuffix
      ></mat-timepicker-toggle>
      <mat-icon matPrefix>access_time</mat-icon>
    </mat-form-field>
  </div>

  <!-- Tipo de impuesto -->
  <mat-form-field appearance="outline" class="w-full">
    <mat-label>Tipo de impuesto</mat-label>
    <mat-select formControlName="taxeTypeId">
      <mat-option *ngFor="let taxe of taxeTypes" [value]="taxe.taxeTypeId">
        {{ taxe.name }}
      </mat-option>
    </mat-select>
    <mat-icon matPrefix>calculate</mat-icon>
  </mat-form-field>

  <!-- Botón para añadir producto -->
  <button
    class="!w-full !rounded-lg"
    mat-fab
    extended="true"
    [disabled]="isLoading"
    (click)="addProduct()"
  >
    <ng-container *ngIf="!isLoading; else loading"> Añadir </ng-container>
    <ng-template #loading>
      <mat-spinner diameter="24" color="accent"></mat-spinner>
    </ng-template>
  </button>
</form>
