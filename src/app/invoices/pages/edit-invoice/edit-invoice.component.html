<app-base-page
  [headerTitle]="'Sistema de Facturación de Hotel'"
  [showContentTitle]="true"
  [showBackButton]="true"
  [showBorder]="false"
  [pxMobile]="false"
  backButtonRoute="/invoice/invoices/list"
  backButtonText="Volver"
  backButtonTooltip="Volver a la lista"
>
  <article class="flex flex-col md:flex-row gap-3 w-full h-full">
    <!-- Mostrar loader solo en carga inicial -->
    @if (initialLoading) {
      <div class="h-full w-full justify-center items-center flex">
        <app-loader></app-loader>
      </div>
    } @else {
      <!-- Columna izquierda -->
      <div class="flex flex-col w-full gap-3">
        <section class="flex flex-col p-4 rounded-2xl border border-[#06a606]">
          <!-- Información de la factura - aparece cuando invoiceData esté disponible -->
          @if (invoiceData) {
            <span class="text-xs md:text-xl font-extrabold">
              {{ invoiceData.invoiceType.name || '' }} Nr°
              {{ invoiceData.code || '' }}
            </span>

            <section class="flex-row md:flex w-full">
              <div
                class="flex w-full md:w-[50%] justify-start text-sm md:text-base"
              >
                <div class="flex flex-col">
                  <div class="flex flex-row gap-2">
                    <span class="font-bold text-xs md:text-base">
                      {{
                        invoiceData.invoiceType.code === 'FC'
                          ? 'PROVEEDOR:'
                          : 'CLIENTE:'
                      }}
                    </span>
                    <span class="font-normal text-xs md:text-base">
                      {{ ' ' + invoiceData.user.firstName || '' }}
                      {{ invoiceData.user.lastName || '' }}
                    </span>
                  </div>
                  <div class="flex flex-row gap-2">
                    <span class="font-bold text-xs md:text-base">
                      {{ invoiceData.user.identificationType.name }}:
                    </span>
                    <span class="font-normal text-xs md:text-base">
                      {{ ' ' + invoiceData.user.identificationNumber || '' }}
                    </span>
                  </div>
                </div>
              </div>
              <div class="flex w-full md:w-[50%] justify-start md:justify-end">
                <span class="font-bold text-xs md:text-base">
                  EMPLEADO:
                  <span class="font-normal text-xs md:text-base">
                    {{ invoiceData.employee.firstName || '' }}
                    {{ invoiceData.employee.lastName || '' }}
                  </span>
                </span>
              </div>
            </section>
          }

          <!-- Tabs siempre visibles después de la carga inicial -->
          <mat-tab-group animationDuration="0ms">
            @if (invoiceData?.invoiceType?.code === 'FV') {
              <!-- Producto: siempre disponible -->
              <mat-tab label="Producto">
                <ng-template matTabContent>
                  <app-add-product
                    [categoryTypes]="categoryTypes"
                    [taxeTypes]="taxeTypes"
                    [saveToBackend]="false"
                    (itemSaved)="onItemSaved()"
                    (pendingItem)="onPendingItem($event)"
                  ></app-add-product>
                </ng-template>
              </mat-tab>

              <mat-tab label="Hospedaje">
                <ng-template matTabContent>
                  <app-add-accommodation
                    [categoryTypes]="categoryTypes"
                    [taxeTypes]="taxeTypes"
                    [additionalTypes]="additionalTypes"
                    [discountTypes]="discountTypes"
                    [saveToBackend]="false"
                    (itemSaved)="onItemSaved()"
                    (pendingItem)="onPendingItem($event)"
                  ></app-add-accommodation>
                </ng-template>
              </mat-tab>

              <mat-tab label="Pasadías y Servicios">
                <ng-template matTabContent>
                  <app-add-excursion
                    [categoryTypes]="categoryTypes"
                    [taxeTypes]="taxeTypes"
                    [saveToBackend]="false"
                    (itemSaved)="onItemSaved()"
                    (pendingItem)="onPendingItem($event)"
                  ></app-add-excursion>
                </ng-template>
              </mat-tab>
            } @else {
              <mat-tab label="Productos">
                <ng-template matTabContent>
                  <app-add-invoice-buy
                    [categoryTypes]="categoryTypes"
                    [taxeTypes]="taxeTypes"
                    [saveToBackend]="false"
                    (itemSaved)="onItemSaved()"
                    (pendingItem)="onPendingItem($event)"
                  ></app-add-invoice-buy>
                </ng-template>
              </mat-tab>

              <mat-tab label="Pasadías y Servicios">
                <ng-template matTabContent>
                  <app-add-invoice-buy-excursion
                    [categoryTypes]="categoryTypes"
                    [taxeTypes]="taxeTypes"
                    [saveToBackend]="false"
                    (itemSaved)="onItemSaved()"
                    (pendingItem)="onPendingItem($event)"
                  ></app-add-invoice-buy-excursion>
                </ng-template>
              </mat-tab>
            }
          </mat-tab-group>
        </section>

        <!-- Sección de Items Pendientes -->
        @if (pendingItems.length > 0) {
          <app-pending-items-table
            [pendingItems]="pendingItems"
            [taxeTypes]="taxeTypes"
            [isSaving]="isSavingItems"
            (itemDeleted)="removePendingItem($event)"
            (saveAll)="saveAllPendingItems()"
          ></app-pending-items-table>
        }

        <!-- Detalle factura - aparece cuando invoiceData esté disponible -->
        <section
          class="flex flex-col p-2 md:p-4 rounded-2xl border border-[#06a606]"
        >
          <div class="w-full text-center">
            <span class="font-bold text-sm md:text-base"
              >Servicios y Productos Ingresados</span
            >
          </div>
          <app-invoice-detaill
            *ngIf="invoiceData"
            [invoiceDetails]="invoiceData.invoiceDetails"
            [invoiceId]="invoiceId"
            [reload]="reloadInvoiceDetails"
            (itemDelete)="onItemDeleted()"
          ></app-invoice-detaill>
        </section>
        <div
          class="flex flex-col w-full p-2 md:p-4 h-min rounded-2xl border border-[#06a606]"
        >
          <app-invoice-summary
            *ngIf="invoiceData"
            [invoiceData]="invoiceData"
            [payTypes]="payTypes"
            (downloadRequested)="downloadInvoice()"
            (editRequested)="openEditInvoiceDialog()"
            (toggleAllPaymentStatus)="toggleAllPayments($event)"
          ></app-invoice-summary>
        </div>
      </div>
    }
  </article>
  <app-invoice-pdf
    class="hidden"
    *ngIf="invoiceData"
    [invoiceData]="invoiceData"
    #invoiceToPrint
  ></app-invoice-pdf>
</app-base-page>
