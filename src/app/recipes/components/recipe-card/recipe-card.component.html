<div class="flex flex-col h-full bg-white rounded-2xl border border-[#06a606]">
  <div
    class="w-full aspect-square overflow-hidden relative group rounded-t-2xl"
  >
    @if (recipe.images && recipe.images.length > 0) {
      <div
        class="absolute inset-0 bg-black/45 flex justify-center items-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10"
      >
        <div
          class="pb-[2px] pt-[7px] px-[9px] rounded-full bg-[#06a606] text-white scale-[0.85] group-hover:scale-100 transition-transform duration-150 shadow-lg cursor-pointer hover:scale-110"
          (click)="
            $event.stopPropagation();
            openPreview(recipe.images[currentImageIndex].imageUrl)
          "
        >
          <mat-icon>zoom_in</mat-icon>
        </div>
      </div>
      <img
        [src]="recipe.images[currentImageIndex].imageUrl"
        [alt]="recipe.productName"
        class="w-full h-full object-cover"
      />

      @if (recipe.images.length > 1) {
        <button
          type="button"
          (click)="$event.stopPropagation(); prevImage(recipe.images.length)"
          class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/70 hover:bg-white text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-10"
        >
          <mat-icon class="text-lg w-[18px] h-[18px]">chevron_left</mat-icon>
        </button>

        <button
          type="button"
          (click)="$event.stopPropagation(); nextImage(recipe.images.length)"
          class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/70 hover:bg-white text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-10"
        >
          <mat-icon class="text-lg w-[18px] h-[18px]">chevron_right</mat-icon>
        </button>
        <div
          class="absolute bottom-2 left-0 right-0 flex justify-center gap-1.5 z-10 w-full px-4"
        >
          @for (img of recipe.images; track img.publicId; let idx = $index) {
            <span
              class="block w-2 h-2 rounded-full transition-all bg-white"
              [class.opacity-40]="currentImageIndex !== idx"
              [class.scale-125]="currentImageIndex === idx"
            ></span>
          }
        </div>
      }
    } @else {
      <div
        class="w-full h-full flex flex-col items-center justify-center text-gray-500 bg-indigo-50"
      >
        <mat-icon class="text-5xl w-12 h-12 opacity-50 mb-2"
          >restaurant</mat-icon
        >
        <span class="text-sm font-medium">Sin imagen</span>
      </div>
    }
  </div>
  <div
    class="flex justify-between items-start px-3 md:px-5 py-2 md:py-4 bg-[#06a606] text-black"
  >
    <div class="flex flex-col items-start gap-1">
      <span class="font-bold text-black text-sm md:text-base">
        {{ recipe.productName }}
      </span>
      <span
        class="inline-flex items-center text-xs md:text-sm font-semibold rounded-full text-black px-2 py-1"
        [ngClass]="{
          'bg-red-500':
            getPortionColor(+(recipe.availablePortions ?? 0)) === 'danger',
          'bg-yellow-500':
            getPortionColor(+(recipe.availablePortions ?? 0)) === 'warning',
          'bg-green-500':
            getPortionColor(+(recipe.availablePortions ?? 0)) === 'success'
        }"
      >
        {{ recipe.availablePortions ?? 0 }} porciones disponibles
      </span>
    </div>
    <div
      class="flex gap-1 [&>button]:!text-white/[0.85] hover:[&>button]:!text-white hover:[&>button]:!bg-white/15"
    >
      @if (canEdit) {
        <button mat-icon-button [matMenuTriggerFor]="actionMenu">
          <mat-icon class="text-black">more_vert</mat-icon>
        </button>
        <mat-menu #actionMenu="matMenu" xPosition="before">
          <button mat-menu-item (click)="edit.emit(recipe)">
            <mat-icon class="blue-color">edit</mat-icon>
            <span>Editar receta</span>
          </button>
          <button mat-menu-item (click)="delete.emit(recipe)">
            <mat-icon class="red-color">delete</mat-icon>
            <span>Eliminar receta</span>
          </button>
        </mat-menu>
      }
    </div>
  </div>
  <div class="px-5 pb-2 overflow-x-auto">
    <table
      mat-table
      [dataSource]="recipe.ingredients"
      class="w-full bg-transparent shadow-none custom-recipe-table"
    >
      <!-- Ingredient Column -->
      <ng-container matColumnDef="ingredient">
        <th mat-header-cell *matHeaderCellDef class="center-text">
          Ingrediente
        </th>
        <td mat-cell *matCellDef="let ing">
          <span
            class="inline-flex items-center text-[0.8rem] md:text-[0.875rem] font-semibold rounded-md px-2 py-1"
            [ngClass]="{
              'bg-red-500 text-white':
                getPortionColor(getIngPortions(ing)) === 'danger',
              'bg-yellow-500 text-black':
                getPortionColor(getIngPortions(ing)) === 'warning',
              'bg-green-500 text-white':
                getPortionColor(getIngPortions(ing)) === 'success'
            }"
          >
            {{ ing.ingredientProductName }}
          </span>
        </td>
      </ng-container>

      <!-- Quantity Column -->
      <ng-container matColumnDef="quantity">
        <th mat-header-cell *matHeaderCellDef class="center-text">Cantidad</th>
        <td mat-cell *matCellDef="let ing" class="center-text">
          {{ ing.quantity | unitFormat: ing.unit : 'qty' | number: '1.0-3' }}
        </td>
      </ng-container>

      <!-- Unit Column -->
      <ng-container matColumnDef="unit">
        <th mat-header-cell *matHeaderCellDef class="center-text">Unidad</th>
        <td mat-cell *matCellDef="let ing" class="center-text">
          {{ ing.quantity | unitFormat: ing.unit : 'unit' }}
        </td>
      </ng-container>

      <!-- Cost Column -->
      <ng-container matColumnDef="cost">
        <th mat-header-cell *matHeaderCellDef class="center-text">Costo</th>
        <td
          mat-cell
          *matCellDef="let ing"
          class="!text-[#43a047] !font-semibold !text-[0.8rem] md:!text-[0.875rem] !text-right !px-2 !py-2 !border-b !border-[#f0f2ff]"
        >
          {{ ing.totalCost | formatCop }}
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
  @if (!isMesero) {
    <div
      class="flex flex-col items-start px-5 py-3.5 border-t border-[#06a606] mt-1 flex-1 rounded-b-2xl"
    >
      <div class="flex flex-col">
        <span class="text-sm md:text-base font-semibold"
          >Costo total de la receta</span
        >
        <span class="text-sm md:text-base font-extrabold text-[#43a047]">
          {{ recipe.totalRecipeCost | formatCop }}
        </span>
      </div>
    </div>
  }
</div>

<!-- Image Preview Overlay -->
@if (previewImageUrl) {
  <div
    class="fixed inset-0 z-[1000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-300"
    (click)="closePreview()"
  >
    <button
      mat-icon-button
      class="!absolute top-4 right-4 text-white hover:bg-white/10"
      (click)="closePreview()"
    >
      <mat-icon>close</mat-icon>
    </button>
    <img
      [src]="previewImageUrl"
      class="max-w-full max-h-[90vh] rounded-lg shadow-2xl animate-in zoom-in-95 duration-300 ring-1 ring-white/20"
      alt="Vista previa de receta"
      (click)="$event.stopPropagation()"
    />
  </div>
}
